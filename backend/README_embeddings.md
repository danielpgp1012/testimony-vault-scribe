Embeddings and pgvector setup

1) Enable pgvector in Supabase (SQL editor):

```sql
create extension if not exists vector with schema extensions;
```

2) Create table for one-embedding-per-testimony (1536 dims for text-embedding-3-small):

```sql
create table if not exists public.testimony_embeddings (
  id bigint generated by default as identity primary key,
  testimony_id bigint not null references public.testimonies(id) on delete cascade,
  embedding vector(1536) not null,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

create unique index if not exists testimony_embeddings_unique on public.testimony_embeddings (testimony_id);

create index if not exists testimony_embeddings_ivfflat on public.testimony_embeddings
using ivfflat (embedding vector_cosine_ops) with (lists = 100);
```

3) RPC for cosine search in Postgres (SQL editor):

```sql
create or replace function public.match_testimonies(
  query_embedding vector(1536),
  match_count int
)
returns table (
  id bigint,
  testimony_id bigint,
  similarity double precision,
  summary text,
  transcript text,
  recorded_at timestamptz,
  church_id text,
  tags text[]
) as $$
  select
    te.id,
    te.testimony_id,
    1 - (te.embedding <=> query_embedding) as similarity,
    t.summary,
    t.transcript,
    t.recorded_at,
    t.church_id,
    t.tags
  from public.testimony_embeddings te
  join public.testimonies t on t.id = te.testimony_id
  order by te.embedding <=> query_embedding
  limit match_count;
$$ language sql stable;
```

4) Backend API endpoint (already added): `GET /testimonies/semantic-search?query=...&k=10`.

3) Backfill existing summaries:

```bash
cd backend
export OPENAI_API_KEY=...  # ensure set
python migrations/embed_existing_summaries.py
```

4) Local qualitative eval:

```bash
cd backend
echo "<summary 1>\n\n<summary 2>" > temp_summaries.txt
python test_embeddings.py
```

Notes
- Only one embedding per testimony. No chunking. The summary (including hashtags) is collapsed to a single line before embedding.
- Default production model: text-embedding-3-small (1536).
